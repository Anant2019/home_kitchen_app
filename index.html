<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiffinFlow - Kitchen Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.4s ease-out forwards;
        }

        .animate-scaleIn {
            animation: scaleIn 0.3s ease-out forwards;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .card-hover {
            transition: all 0.2s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>

<body class="bg-neutral-950 text-neutral-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function TiffinFlowMaster() {
            const [user, setUser] = useState(null);
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [selectedKitchen, setSelectedKitchen] = useState(null);
            const [activeTab, setActiveTab] = useState('menu');
            const [loginData, setLoginData] = useState({ user: '', pass: '' });

            // --- DATABASE ---
            const [kitchens, setKitchens] = useState([
                { id: 'kitchen1', name: 'Annapurna Kitchen', location: 'Nigdi', isOpen: true },
                { id: 'kitchen2', name: 'PCMC Delights', location: 'Chinchwad', isOpen: false },
                { id: 'kitchen3', name: 'Healthy Bites', location: 'Pimple Saudagar', isOpen: true }
            ]);

            const [menu, setMenu] = useState([
                { id: 1, owner: 'kitchen1', name: 'Special Veg Thali', price: 120, description: 'Delicious veg thali with roti, sabji, dal, rice, and sweet.', img: 'https://loremflickr.com/400/300/indian,thali/all' }
            ]);

            const [orders, setOrders] = useState([]);

            // --- WHATSAPP SIMULATOR STATE ---
            const [waMessage, setWaMessage] = useState('');
            const [waChatLog, setWaChatLog] = useState([]);
            const [waIsGroup, setWaIsGroup] = useState(false);
            const [waLoading, setWaLoading] = useState(false);

            // --- SETTINGS STATE (Razorpay) ---
            const [settings, setSettings] = useState({
                razorpay_key_id: '',
                razorpay_key_secret: '',
                payments_enabled: false
            });
            const [settingsLoading, setSettingsLoading] = useState(false);
            const [settingsSaved, setSettingsSaved] = useState(false);

            // Fetch settings when kitchen is selected
            useEffect(() => {
                if (!token || !selectedKitchen) return;

                fetch('/api/kitchen/settings', {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                    .then(res => res.ok ? res.json() : null)
                    .then(data => {
                        if (data) {
                            setSettings({
                                razorpay_key_id: data.razorpay_key_id || '',
                                razorpay_key_secret: data.razorpay_key_secret_masked || '',
                                payments_enabled: data.payments_enabled || false
                            });
                        }
                    });
            }, [token, selectedKitchen]);

            const saveSettings = async () => {
                setSettingsLoading(true);
                setSettingsSaved(false);
                try {
                    const res = await fetch('/api/kitchen/settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(settings)
                    });
                    if (res.ok) {
                        setSettingsSaved(true);
                        setTimeout(() => setSettingsSaved(false), 3000);
                    }
                } catch (e) {
                    alert('Failed to save settings');
                } finally {
                    setSettingsLoading(false);
                }
            };
            const handleWASend = async (e) => {
                e.preventDefault();
                if (!waMessage.trim()) return;

                const userMsg = { sender: 'User', text: waMessage, isUser: true };
                setWaChatLog(prev => [...prev, userMsg]);
                setWaLoading(true);
                const msgToSend = waMessage;
                setWaMessage('');

                try {
                    const res = await fetch('/api/whatsapp-webhook', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: msgToSend,
                            isGroup: waIsGroup,
                            sender: '9876543210',
                            kitchenId: selectedKitchen
                        })
                    });
                    const data = await res.json();
                    setWaChatLog(prev => [...prev, { sender: 'Bot', text: data.response, isUser: false }]);
                } catch (e) {
                    setWaChatLog(prev => [...prev, { sender: 'System', text: "Error: " + e.message, isUser: false }]);
                } finally {
                    setWaLoading(false);
                }
            };

            // --- SYNC LOGIC ---
            useEffect(() => {
                if (!selectedKitchen) return;

                // Fetch initial menu (Public)
                fetch(`/api/menu?kitchenId=${selectedKitchen}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.length > 0) setMenu(data);
                    });

                // Poll for orders (Protected)
                if (!token) return;

                const fetchOrders = () => {
                    fetch(`/api/orders?kitchenId=${selectedKitchen}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                        .then(res => {
                            if (res.status === 401 || res.status === 403) {
                                handleLogout();
                                return [];
                            }
                            return res.json();
                        })
                        .then(data => {
                            if (Array.isArray(data)) setOrders(data);
                        });
                };

                fetchOrders(); // Initial fetch
                const interval = setInterval(fetchOrders, 5000);

                return () => clearInterval(interval);
            }, [selectedKitchen, token]);

            const saveMenuToServer = (newMenu) => {
                fetch('/api/menu', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ kitchenId: selectedKitchen, menu: newMenu })
                });
            };

            const [newItem, setNewItem] = useState({ name: '', price: '', description: '', img: '' });
            const [showAddModal, setShowAddModal] = useState(false);
            const [loadingAI, setLoadingAI] = useState(false);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setNewItem(prev => ({ ...prev, img: reader.result }));
                    };
                    reader.readAsDataURL(file);
                }
            };

            const generateAIContent = async () => {
                if (!newItem.name) return alert("Please enter a dish name first!");
                setLoadingAI(true);
                try {
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ dish_name: newItem.name })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    const aiImg = `https://loremflickr.com/400/300/food,${encodeURIComponent(data.image_keyword)}/all`;
                    setNewItem(prev => ({ ...prev, description: data.description, img: aiImg }));
                } catch (e) {
                    alert("AI Generation Failed: " + e.message);
                } finally {
                    setLoadingAI(false);
                }
            };

            // --- AUTH LOGIC ---
            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: loginData.user, password: loginData.pass })
                    });

                    if (!res.ok) throw new Error("Invalid Credentials");

                    const data = await res.json();
                    setToken(data.token);
                    localStorage.setItem('token', data.token);

                    // Set User State
                    setUser({ id: data.kitchenId, role: 'KITCHEN_OWNER', name: 'Annapurna Kitchen' }); // Name hardcoded for now or fetch from DB later
                    setSelectedKitchen(data.kitchenId);
                } catch (err) {
                    alert(err.message);
                }
            };

            const handleLogout = () => {
                setUser(null);
                setToken(null);
                localStorage.removeItem('token');
                setSelectedKitchen(null);
                setLoginData({ user: '', pass: '' });
            };

            const toggleKitchenStatus = (id) => {
                setKitchens(kitchens.map(k => k.id === id ? { ...k, isOpen: !k.isOpen } : k));
            };

            const broadcast = () => {
                const kInfo = kitchens.find(k => k.id === selectedKitchen);
                const kMenu = menu.filter(m => m.owner === selectedKitchen);
                const appUrl = `${window.location.origin}/customer.html?kitchenId=${selectedKitchen}`;
                const date = new Date().toLocaleDateString('en-IN', { weekday: 'long', day: 'numeric', month: 'short' });

                let msg = `*üìÖ MENU FOR ${date.toUpperCase()} üìÖ*\n`;
                msg += `*${kInfo.name.toUpperCase()}*\n`;
                msg += `--------------------------------\n\n`;

                kMenu.forEach((item, index) => {
                    msg += `*${index + 1}. ${item.name}* ‚Äî ‚Çπ${item.price}\n`;
                    msg += `   ${item.description}\n`;
                    if (item.img && !item.img.startsWith('data:')) {
                        msg += `   üñºÔ∏è View: ${item.img}\n`;
                    }
                    msg += `\n`;
                });

                msg += `--------------------------------\n`;
                msg += `*üëá TAP TO ORDER NOW üëá*\n`;
                msg += `${appUrl}`;

                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            };

            // --- UI: LOGIN SCREEN ---
            if (!user) {
                return (
                    <div className="relative min-h-screen flex items-center justify-center overflow-hidden">
                        {/* Hero Background */}
                        <div className="absolute inset-0 z-0">
                            <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=1200" className="w-full h-full object-cover" alt="Food" />
                            <div className="absolute inset-0 bg-gradient-to-b from-neutral-950/70 via-neutral-950/90 to-neutral-950"></div>
                        </div>

                        {/* Login Card */}
                        <div className="relative z-10 w-full max-w-sm mx-6 animate-fadeInUp">
                            <div className="glass rounded-3xl p-8 shadow-2xl">
                                {/* Logo */}
                                <div className="text-center mb-8">
                                    <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl mb-4 shadow-lg shadow-orange-600/30">
                                        <span className="text-3xl">üç±</span>
                                    </div>
                                    <h1 className="text-3xl font-extrabold text-white tracking-tight">TiffinFlow</h1>
                                    <p className="text-neutral-500 text-sm mt-1">Kitchen Dashboard</p>
                                </div>

                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div className="relative">
                                        <input
                                            className="w-full bg-neutral-900/80 px-5 py-4 rounded-2xl text-white placeholder-neutral-500 border border-neutral-800 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 outline-none transition-all"
                                            placeholder="Kitchen ID"
                                            value={loginData.user}
                                            onChange={e => setLoginData({ ...loginData, user: e.target.value })}
                                        />
                                    </div>
                                    <div className="relative">
                                        <input
                                            className="w-full bg-neutral-900/80 px-5 py-4 rounded-2xl text-white placeholder-neutral-500 border border-neutral-800 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 outline-none transition-all"
                                            type="password"
                                            placeholder="Password"
                                            value={loginData.pass}
                                            onChange={e => setLoginData({ ...loginData, pass: e.target.value })}
                                        />
                                    </div>
                                    <button className="w-full bg-gradient-to-r from-orange-500 to-red-600 py-4 rounded-2xl font-bold text-white shadow-lg shadow-orange-600/30 hover:shadow-orange-600/50 active:scale-[0.98] transition-all mt-2">
                                        Sign In
                                    </button>
                                </form>

                                <p className="text-center text-neutral-600 text-xs mt-6">
                                    Powered by TiffinFlow SaaS
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            // --- UI: DIRECTORY (Super Admin Only) ---
            if (user.role === 'SUPER_ADMIN' && !selectedKitchen) {
                return (
                    <div className="max-w-md mx-auto min-h-screen flex flex-col bg-slate-950 border-x border-slate-800">
                        <header className="p-8 border-b border-slate-800 flex justify-between items-center bg-slate-900/30">
                            <div>
                                <h1 className="text-2xl font-black text-blue-500 tracking-tighter uppercase">Directory</h1>
                                <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Global PCMC View</p>
                            </div>
                            <button onClick={handleLogout} className="bg-slate-800 p-3 rounded-2xl text-red-500 hover:bg-red-500/10 transition">
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                            </button>
                        </header>
                        <main className="p-6 space-y-4 flex-1">
                            {kitchens.map(k => (
                                <div key={k.id} className="bg-slate-900/50 border border-slate-800 p-5 rounded-[2rem] flex justify-between items-center group hover:border-slate-600 transition shadow-lg">
                                    <div onClick={() => setSelectedKitchen(k.id)} className="cursor-pointer flex-1">
                                        <h3 className="font-black text-lg text-slate-100 group-hover:text-blue-400 transition-colors">{k.name}</h3>
                                        <div className="flex items-center gap-2 mt-1">
                                            <span className={`w-2 h-2 rounded-full ${k.isOpen ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>
                                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">{k.isOpen ? 'Accepting Orders' : 'Closed'} ‚Ä¢ {k.location}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => toggleKitchenStatus(k.id)} className={`px-4 py-2 rounded-xl text-[9px] font-black uppercase border transition ${k.isOpen ? 'border-red-500/20 text-red-500 hover:bg-red-500/10' : 'border-green-500/20 text-green-500 hover:bg-green-500/10'}`}>
                                        {k.isOpen ? 'Offline' : 'Online'}
                                    </button>
                                </div>
                            ))}
                        </main>
                        <footer className="p-6 text-center text-[10px] text-slate-600 font-bold uppercase tracking-widest border-t border-slate-900">
                            Logged in as Master Admin
                        </footer>
                    </div>
                );
            }

            // --- UI: KITCHEN MANAGEMENT ---
            const currentK = kitchens.find(k => k.id === selectedKitchen);

            return (
                <div className="max-w-md mx-auto min-h-screen flex flex-col bg-neutral-950">
                    {/* Modern Glass Header */}
                    <header className="glass sticky top-0 z-50">
                        <div className="px-5 py-4">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    {user.role === 'SUPER_ADMIN' ? (
                                        <button onClick={() => setSelectedKitchen(null)} className="w-10 h-10 bg-neutral-900 border border-neutral-800 rounded-xl flex items-center justify-center text-orange-500 hover:bg-neutral-800 transition">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                        </button>
                                    ) : (
                                        <button onClick={handleLogout} className="w-10 h-10 bg-neutral-900 border border-neutral-800 rounded-xl flex items-center justify-center text-red-500 hover:bg-red-500/10 transition">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                        </button>
                                    )}
                                    <div>
                                        <h1 className="text-lg font-bold text-white leading-tight">{currentK.name}</h1>
                                        <p className="text-neutral-500 text-xs">{user.role === 'SUPER_ADMIN' ? 'Managing Partner' : 'Kitchen Owner'}</p>
                                    </div>
                                </div>
                                {/* Status Toggle */}
                                <button onClick={() => toggleKitchenStatus(selectedKitchen)} className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-semibold transition ${currentK.isOpen ? 'bg-green-500/10 text-green-500 border border-green-500/30' : 'bg-neutral-800 text-neutral-400 border border-neutral-700'}`}>
                                    <span className={`w-2 h-2 rounded-full ${currentK.isOpen ? 'bg-green-500 animate-pulse' : 'bg-neutral-500'}`}></span>
                                    {currentK.isOpen ? 'Open' : 'Closed'}
                                </button>
                            </div>
                        </div>

                        {/* Tab Navigation */}
                        <div className="px-5 pb-4">
                            <div className="flex bg-neutral-900 rounded-2xl p-1 border border-neutral-800">
                                <button onClick={() => setActiveTab('menu')} className={`flex-1 py-2.5 text-sm font-semibold rounded-xl transition-all ${activeTab === 'menu' ? 'bg-gradient-to-r from-orange-500 to-red-600 text-white shadow-lg' : 'text-neutral-500 hover:text-neutral-300'}`}>
                                    Menu
                                </button>
                                <button onClick={() => setActiveTab('orders')} className={`flex-1 py-2.5 text-sm font-semibold rounded-xl transition-all ${activeTab === 'orders' ? 'bg-gradient-to-r from-orange-500 to-red-600 text-white shadow-lg' : 'text-neutral-500 hover:text-neutral-300'}`}>
                                    Orders
                                </button>
                                <button onClick={() => setActiveTab('whatsapp')} className={`flex-1 py-2.5 text-sm font-semibold rounded-xl transition-all ${activeTab === 'whatsapp' ? 'bg-green-600 text-white shadow-lg' : 'text-neutral-500 hover:text-neutral-300'}`}>
                                    WhatsApp
                                </button>
                                <button onClick={() => setActiveTab('settings')} className={`flex-1 py-2.5 text-sm font-semibold rounded-xl transition-all ${activeTab === 'settings' ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' : 'text-neutral-500 hover:text-neutral-300'}`}>
                                    ‚öôÔ∏è
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="p-5 flex-1 overflow-y-auto pb-40">
                        {activeTab === 'menu' ? (
                            <div className="space-y-4 animate-fadeInUp">
                                {menu.filter(m => m.owner === selectedKitchen).length === 0 && (
                                    <div className="text-center py-16">
                                        <div className="text-5xl mb-4">üçΩÔ∏è</div>
                                        <h3 className="text-lg font-semibold text-neutral-300">No dishes yet</h3>
                                        <p className="text-neutral-500 text-sm">Tap the + button to add your first dish</p>
                                    </div>
                                )}
                                {menu.filter(m => m.owner === selectedKitchen).map(item => (
                                    <div key={item.id} className="glass rounded-3xl overflow-hidden card-hover animate-scaleIn">
                                        <div className="flex">
                                            <img src={item.img} className="w-28 h-28 object-cover" alt={item.name} />
                                            <div className="flex-1 p-4 flex flex-col justify-between">
                                                <div>
                                                    <h4 className="font-bold text-white">{item.name}</h4>
                                                    <p className="text-neutral-400 text-xs line-clamp-2 mt-1">{item.description}</p>
                                                </div>
                                                <div className="flex items-center justify-between mt-2">
                                                    <span className="text-orange-500 font-bold text-lg">‚Çπ{item.price}</span>
                                                    <button onClick={() => setMenu(menu.filter(m => m.id !== item.id))} className="w-8 h-8 flex items-center justify-center text-neutral-500 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition">
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>

                        ) : activeTab === 'whatsapp' ? (
                            <div className="animate-fadeInUp h-full flex flex-col">
                                <div className="glass rounded-3xl flex-1 flex flex-col overflow-hidden">
                                    {/* WhatsApp Header */}
                                    <div className="flex items-center gap-3 p-4 border-b border-neutral-800">
                                        <div className="w-10 h-10 bg-green-600 rounded-full flex items-center justify-center">
                                            <svg className="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" /></svg>
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="font-semibold text-white">WhatsApp Bot Simulator</h3>
                                            <p className="text-xs text-neutral-400">Test your chatbot responses</p>
                                        </div>
                                        <label className="flex items-center gap-2 cursor-pointer bg-neutral-900 px-3 py-1.5 rounded-full border border-neutral-800">
                                            <span className="text-xs text-neutral-400">Group</span>
                                            <input type="checkbox" checked={waIsGroup} onChange={e => setWaIsGroup(e.target.checked)} className="w-4 h-4 accent-green-500" />
                                        </label>
                                    </div>

                                    {/* Chat Messages */}
                                    <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-neutral-950/50">
                                        {waChatLog.length === 0 && <p className="text-center text-neutral-600 text-sm mt-10">Send a message to start...</p>}
                                        {waChatLog.map((msg, i) => (
                                            <div key={i} className={`flex ${msg.isUser ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-[80%] px-4 py-2.5 rounded-2xl text-sm ${msg.isUser ? 'bg-green-600 text-white rounded-tr-sm' : 'bg-neutral-800 text-neutral-100 rounded-tl-sm'}`}>
                                                    <p className="font-medium text-[10px] opacity-70 mb-1">{msg.sender}</p>
                                                    {msg.text}
                                                </div>
                                            </div>
                                        ))}
                                        {waLoading && <div className="flex justify-start"><div className="bg-neutral-800 px-4 py-2.5 rounded-2xl text-sm text-neutral-400 animate-pulse">Typing...</div></div>}
                                    </div>

                                    {/* Input */}
                                    <form onSubmit={handleWASend} className="p-4 border-t border-neutral-800 flex gap-2">
                                        <input className="flex-1 bg-neutral-900 rounded-xl px-4 py-3 text-sm text-white placeholder-neutral-500 border border-neutral-800 focus:border-green-500 outline-none transition" placeholder="Type a message..." value={waMessage} onChange={e => setWaMessage(e.target.value)} />
                                        <button type="submit" disabled={waLoading} className="bg-green-600 w-12 rounded-xl flex items-center justify-center text-white hover:bg-green-500 active:scale-95 transition disabled:opacity-50">
                                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        ) : activeTab === 'settings' ? (
                            <div className="space-y-6 animate-fadeInUp max-w-lg mx-auto">
                                <div className="glass rounded-3xl p-6">
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center">
                                            <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                        </div>
                                        <div>
                                            <h3 className="text-xl font-bold text-white">Payment Settings</h3>
                                            <p className="text-sm text-neutral-400">Configure Razorpay for online payments</p>
                                        </div>
                                    </div>

                                    <div className="space-y-4">
                                        {/* Enable Payments Toggle */}
                                        <div className="flex items-center justify-between bg-neutral-900 rounded-xl p-4 border border-neutral-800">
                                            <div>
                                                <p className="font-semibold text-white">Enable Online Payments</p>
                                                <p className="text-xs text-neutral-500">Allow customers to pay via Razorpay</p>
                                            </div>
                                            <label className="relative inline-flex items-center cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    className="sr-only peer"
                                                    checked={settings.payments_enabled}
                                                    onChange={e => setSettings(prev => ({ ...prev, payments_enabled: e.target.checked }))}
                                                />
                                                <div className="w-11 h-6 bg-neutral-700 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-neutral-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                                            </label>
                                        </div>

                                        {/* Razorpay Key ID */}
                                        <div>
                                            <label className="block text-sm font-semibold text-neutral-400 mb-2">Razorpay Key ID</label>
                                            <input
                                                type="text"
                                                className="w-full bg-neutral-900 rounded-xl px-4 py-3 text-white placeholder-neutral-500 border border-neutral-800 focus:border-blue-500 outline-none transition"
                                                placeholder="rzp_test_xxxxxxxxxxxxxx"
                                                value={settings.razorpay_key_id}
                                                onChange={e => setSettings(prev => ({ ...prev, razorpay_key_id: e.target.value }))}
                                            />
                                        </div>

                                        {/* Razorpay Key Secret */}
                                        <div>
                                            <label className="block text-sm font-semibold text-neutral-400 mb-2">Razorpay Key Secret</label>
                                            <input
                                                type="password"
                                                className="w-full bg-neutral-900 rounded-xl px-4 py-3 text-white placeholder-neutral-500 border border-neutral-800 focus:border-blue-500 outline-none transition"
                                                placeholder="Enter new secret to update (masked for security)"
                                                value={settings.razorpay_key_secret}
                                                onChange={e => setSettings(prev => ({ ...prev, razorpay_key_secret: e.target.value }))}
                                            />
                                            <p className="text-xs text-neutral-600 mt-1">Leave as-is to keep existing secret</p>
                                        </div>

                                        {/* Save Button */}
                                        <button
                                            onClick={saveSettings}
                                            disabled={settingsLoading}
                                            className="w-full bg-gradient-to-r from-blue-500 to-purple-600 py-4 rounded-xl font-bold text-white shadow-lg shadow-blue-600/30 active:scale-[0.98] transition disabled:opacity-50 flex items-center justify-center gap-2"
                                        >
                                            {settingsLoading ? (
                                                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            ) : settingsSaved ? (
                                                <>
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                                    Saved!
                                                </>
                                            ) : 'Save Settings'}
                                        </button>
                                    </div>
                                </div>

                                {/* Help Section */}
                                <div className="glass rounded-2xl p-4 border border-blue-500/20">
                                    <h4 className="font-semibold text-blue-400 mb-2">üí° How to get Razorpay Keys?</h4>
                                    <ol className="text-sm text-neutral-400 space-y-1 list-decimal list-inside">
                                        <li>Go to <a href="https://dashboard.razorpay.com" target="_blank" className="text-blue-400 hover:underline">dashboard.razorpay.com</a></li>
                                        <li>Sign up or log in to your account</li>
                                        <li>Navigate to Settings ‚Üí API Keys</li>
                                        <li>Generate a new Key ID and Key Secret</li>
                                        <li>Use Test Mode keys for testing</li>
                                    </ol>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4 animate-fadeInUp">
                                {orders.filter(o => o.owner === selectedKitchen).length === 0 && (
                                    <div className="text-center py-16">
                                        <div className="text-5xl mb-4">üì¶</div>
                                        <h3 className="text-lg font-semibold text-neutral-300">No orders yet</h3>
                                        <p className="text-neutral-500 text-sm">Orders will appear here when customers place them</p>
                                    </div>
                                )}
                                {orders.filter(o => o.owner === selectedKitchen).map(order => (
                                    <div key={order.id} className="glass rounded-3xl p-5 card-hover animate-scaleIn">
                                        {/* Order Header */}
                                        <div className="flex justify-between items-start mb-4">
                                            <div>
                                                <span className="text-xs font-semibold text-orange-500 bg-orange-500/10 px-2 py-0.5 rounded-full">{order.id}</span>
                                                <h3 className="text-lg font-bold text-white mt-2">{order.items}</h3>
                                                <p className="text-neutral-500 text-xs mt-1">{order.time}</p>
                                            </div>
                                            <div className="bg-gradient-to-r from-orange-500 to-red-600 px-4 py-2 rounded-xl font-bold text-white shadow-lg">
                                                ‚Çπ{order.total}
                                            </div>
                                        </div>

                                        {/* Customer Details */}
                                        {order.customer && (
                                            <div className="bg-neutral-900/50 rounded-xl p-4 mb-4 border border-neutral-800">
                                                {/* Customer Name & Phone */}
                                                <div className="flex items-center gap-2 mb-3">
                                                    <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                                        {order.customer.name ? order.customer.name.charAt(0).toUpperCase() : '?'}
                                                    </div>
                                                    <div>
                                                        <p className="text-white font-semibold text-sm">{order.customer.name || 'Unknown'}</p>
                                                        <a href={`tel:${order.customer.phone}`} className="text-orange-400 text-xs hover:underline">
                                                            üìû {order.customer.phone || 'N/A'}
                                                        </a>
                                                    </div>
                                                </div>

                                                {/* Structured Address */}
                                                <div className="pt-3 border-t border-neutral-800">
                                                    <div className="grid grid-cols-2 gap-2 text-xs mb-3">
                                                        {order.customer.flatNo && (
                                                            <div className="bg-neutral-800/50 px-2 py-1.5 rounded-lg">
                                                                <span className="text-neutral-500">Flat: </span>
                                                                <span className="text-white">{order.customer.flatNo}</span>
                                                            </div>
                                                        )}
                                                        {order.customer.societyName && (
                                                            <div className="bg-neutral-800/50 px-2 py-1.5 rounded-lg">
                                                                <span className="text-neutral-500">Society: </span>
                                                                <span className="text-white">{order.customer.societyName}</span>
                                                            </div>
                                                        )}
                                                        {order.customer.area && (
                                                            <div className="bg-neutral-800/50 px-2 py-1.5 rounded-lg">
                                                                <span className="text-neutral-500">Area: </span>
                                                                <span className="text-white">{order.customer.area}</span>
                                                            </div>
                                                        )}
                                                        {order.customer.pincode && (
                                                            <div className="bg-neutral-800/50 px-2 py-1.5 rounded-lg">
                                                                <span className="text-neutral-500">Pin: </span>
                                                                <span className="text-white">{order.customer.pincode}</span>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* Google Maps Button */}
                                                    {order.customer.gpsLocation ? (
                                                        <a
                                                            href={order.customer.gpsLocation}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="flex items-center justify-center gap-2 w-full bg-green-600/20 text-green-400 px-3 py-2.5 rounded-lg text-xs font-semibold hover:bg-green-600/30 transition border border-green-500/30"
                                                        >
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                                            Open in Google Maps
                                                        </a>
                                                    ) : order.customer.address ? (
                                                        <a
                                                            href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.customer.address)}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="flex items-center justify-center gap-2 w-full bg-neutral-800 text-neutral-300 px-3 py-2.5 rounded-lg text-xs font-semibold hover:bg-neutral-700 transition"
                                                        >
                                                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                                            Search Address on Maps
                                                        </a>
                                                    ) : null}
                                                </div>
                                            </div>
                                        )}

                                        {/* Status */}
                                        <div className="flex items-center gap-2 pt-4 border-t border-neutral-800">
                                            <span className={`w-2 h-2 rounded-full ${order.status === 'pending' ? 'bg-yellow-500 animate-pulse' : order.status === 'completed' ? 'bg-green-500' : 'bg-blue-500'}`}></span>
                                            <span className="text-sm text-neutral-400 capitalize">{order.status}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Bottom Bar - Broadcast */}
                    <div className="fixed bottom-0 left-0 right-0 max-w-md mx-auto z-30">
                        <div className="bg-gradient-to-t from-neutral-950 via-neutral-950/95 to-transparent pt-6 pb-6 px-5">
                            <button onClick={broadcast} className="w-full bg-green-600 hover:bg-green-500 text-white py-4 rounded-2xl font-semibold shadow-lg shadow-green-600/30 flex justify-center items-center gap-3 active:scale-[0.98] transition-all">
                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" /></svg>
                                Share on WhatsApp
                            </button>
                        </div>
                    </div>

                    {/* FAB for Adding Menu */}
                    {activeTab === 'menu' && (
                        <div className="fixed bottom-28 right-4 z-40 max-w-md">
                            <button onClick={() => setShowAddModal(true)} className="w-14 h-14 bg-gradient-to-r from-orange-500 to-red-600 rounded-full shadow-xl shadow-orange-600/40 flex items-center justify-center text-white hover:shadow-orange-600/60 active:scale-90 transition-all">
                                <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 6v6m0 0v6m0-6h6m-6 0H6" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" /></svg>
                            </button>
                        </div>
                    )}

                    {/* ADD MENU MODAL */}
                    {showAddModal && (
                        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-neutral-950/80 backdrop-blur-sm animate-fadeInUp">
                            <div className="glass w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 animate-scaleIn">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-white">Add New Dish</h3>
                                    <button onClick={() => setShowAddModal(false)} className="w-8 h-8 bg-neutral-800 rounded-full flex items-center justify-center text-neutral-400 hover:text-white hover:bg-neutral-700 transition">
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" strokeWidth="2" strokeLinecap="round" /></svg>
                                    </button>
                                </div>

                                <div className="space-y-4">
                                    <div className="flex gap-2">
                                        <input className="flex-1 bg-neutral-900 rounded-xl px-4 py-3 text-white placeholder-neutral-500 border border-neutral-800 focus:border-orange-500 outline-none transition" placeholder="Dish name..." value={newItem.name} onChange={e => setNewItem({ ...newItem, name: e.target.value })} />
                                        <button onClick={generateAIContent} disabled={loadingAI} className="bg-gradient-to-r from-purple-500 to-pink-600 px-4 rounded-xl font-semibold text-sm text-white shadow-lg active:scale-95 transition disabled:opacity-50">
                                            {loadingAI ? '...' : '‚ú® AI'}
                                        </button>
                                    </div>

                                    <textarea className="w-full bg-neutral-900 rounded-xl px-4 py-3 text-white placeholder-neutral-500 border border-neutral-800 focus:border-orange-500 outline-none transition h-24 resize-none" placeholder="Description..." value={newItem.description} onChange={e => setNewItem({ ...newItem, description: e.target.value })}></textarea>

                                    <input className="w-full bg-neutral-900 rounded-xl px-4 py-3 text-white placeholder-neutral-500 border border-neutral-800 focus:border-orange-500 outline-none transition" placeholder="Price (‚Çπ)" type="number" value={newItem.price} onChange={e => setNewItem({ ...newItem, price: e.target.value })} />

                                    <div className="bg-neutral-900 rounded-xl p-4 border border-dashed border-neutral-700 text-center relative group hover:border-orange-500 transition cursor-pointer">
                                        <input type="file" accept="image/*" onChange={handleImageUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        {newItem.img ? (
                                            <img src={newItem.img} className="h-24 w-full object-cover rounded-lg" />
                                        ) : (
                                            <div className="text-neutral-500 py-2">
                                                <span className="block text-2xl mb-1">üì∑</span>
                                                <span className="text-sm">Upload Photo</span>
                                            </div>
                                        )}
                                    </div>

                                    <button onClick={() => {
                                        if (!newItem.name || !newItem.price) return alert("Name and Price are required!");
                                        const finalImg = newItem.img || `https://loremflickr.com/400/300/indian,food,${encodeURIComponent(newItem.name)}/all`;
                                        const updatedMenu = [...menu, { id: Date.now(), owner: selectedKitchen, name: newItem.name, price: newItem.price, description: newItem.description, img: finalImg }];
                                        setMenu(updatedMenu);
                                        saveMenuToServer(updatedMenu);
                                        setNewItem({ name: '', price: '', description: '', img: '' });
                                        setShowAddModal(false);
                                    }} className="w-full bg-gradient-to-r from-orange-500 to-red-600 py-4 rounded-xl font-bold text-white shadow-lg shadow-orange-600/30 active:scale-[0.98] transition-all">
                                        Add to Menu
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}


                </div >
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TiffinFlowMaster />);
    </script>
</body>

</html>
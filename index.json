const express = require('express');
const axios = require('axios');
const app = express();
app.use(express.json());

// CONFIGURATION (Intern must set these in Render Environment Variables)
const FB_DB_URL = process.env.FB_DB_URL; 
const META_TOKEN = process.env.META_TOKEN;
const PHONE_ID = process.env.PHONE_ID;
const VERIFY_TOKEN = "tiffin_demo_secret"; // Set this in Meta Webhook config

// 1. Webhook Verification for Meta
app.get('/webhook', (req, res) => {
    if (req.query['hub.verify_token'] === VERIFY_TOKEN) {
        res.send(req.query['hub.challenge']);
    } else {
        res.sendStatus(403);
    }
});

// 2. Handle Incoming WhatsApp Messages
app.post('/webhook', async (req, res) => {
    const entry = req.body.entry?.[0]?.changes?.[0]?.value;
    const message = entry?.messages?.[0];

    if (message?.type === 'text') {
        const from = message.from;
        const text = message.text.body.toLowerCase();

        if (text === 'menu') {
            try {
                // Fetch LIVE Menu from Firebase
                const response = await axios.get(`${FB_DB_URL}/menus.json`);
                const kitchens = response.data;

                // Build a professional List Message
                await axios.post(`https://graph.facebook.com/v21.0/${PHONE_ID}/messages`, {
                    messaging_product: "whatsapp",
                    to: from,
                    type: "interactive",
                    interactive: {
                        type: "list",
                        header: { type: "text", text: "ðŸ± TiffinFlow Menu" },
                        body: { text: "Choose a kitchen to see today's special thali:" },
                        footer: { text: "Quality Home Food" },
                        action: {
                            button: "Select Kitchen",
                            sections: [{
                                title: "Available Kitchens",
                                rows: Object.keys(kitchens).map(id => ({
                                    id: id,
                                    title: kitchens[id].name,
                                    description: `View today's menu`
                                }))
                            }]
                        }
                    }
                }, { headers: { Authorization: `Bearer ${META_TOKEN}` } });

            } catch (err) {
                console.error("Error fetching menu:", err.message);
            }
        }
    }

    // Handle Button Clicks (When user selects a kitchen)
    if (message?.type === 'interactive') {
        const selectionId = message.interactive.list_reply.id;
        const from = message.from;

        const response = await axios.get(`${FB_DB_URL}/menus/${selectionId}.json`);
        const menu = response.data;

        await axios.post(`https://graph.facebook.com/v21.0/${PHONE_ID}/messages`, {
            messaging_product: "whatsapp",
            to: from,
            text: { body: `*${menu.name} Today's Menu:*\n\n${menu.items}\n\nPrice: â‚¹${menu.price}\n\nReply 'ORDER' to confirm.` }
        }, { headers: { Authorization: `Bearer ${META_TOKEN}` } });
    }

    res.sendStatus(200);
});

const PORT = process.env.PORT || 10000;
app.listen(PORT, () => console.log(`Server live on ${PORT}`));
